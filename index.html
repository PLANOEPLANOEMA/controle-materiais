<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Controle de Materiais de Empr√©stimo - Plano & Plano</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    /* ‚îÄ‚îÄ Reset & Base ‚îÄ‚îÄ */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --blue-dark:  #1F3864;
      --blue-mid:   #2E75B6;
      --blue-light: #DDEEFF;
      --accent:     #E84545;
      --success:    #27AE60;
      --warning:    #F5A623;
      --bg:         #F0F4FA;
      --card:       #FFFFFF;
      --text:       #1a2340;
      --muted:      #6b7a99;
      --radius:     14px;
      --shadow:     0 4px 24px rgba(31,56,100,.10);
    }
    html { scroll-behavior: smooth; }
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    /* ‚îÄ‚îÄ LOGIN SCREEN ‚îÄ‚îÄ */
    #login-screen {
      position: fixed;
      inset: 0;
      background: linear-gradient(135deg, var(--blue-dark) 0%, var(--blue-mid) 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      padding: 1rem;
    }
    #login-screen.hidden {
      display: none;
    }
    .login-container {
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      padding: 3rem 2rem;
      width: 100%;
      max-width: 420px;
      text-align: center;
    }
    .login-logo {
      margin-bottom: 2rem;
    }
    .login-logo img {
      height: 80px;
      width: auto;
      object-fit: contain;
    }
    .login-container h1 {
      font-size: 1.8rem;
      color: var(--blue-dark);
      margin-bottom: 0.5rem;
      font-weight: 800;
    }
    .login-container p {
      color: var(--muted);
      margin-bottom: 2rem;
      font-size: 0.95rem;
    }
    .login-form {
      display: flex;
      flex-direction: column;
      gap: 1.25rem;
    }
    .login-form .form-group {
      text-align: left;
    }
    .login-form label {
      display: block;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: var(--blue-dark);
      font-size: 0.9rem;
    }
    .login-form input {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 2px solid #c8d6ea;
      border-radius: 8px;
      font-size: 1rem;
      outline: none;
      transition: all 0.2s;
    }
    .login-form input:focus {
      border-color: var(--blue-mid);
      box-shadow: 0 0 0 4px rgba(46,117,182,0.1);
    }
    .login-form button {
      padding: 0.85rem 1.5rem;
      background: linear-gradient(135deg, var(--blue-dark) 0%, var(--blue-mid) 100%);
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
      margin-top: 0.5rem;
    }
    .login-form button:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(31,56,100,0.3);
    }
    .login-form button:active {
      transform: translateY(0);
    }
    .login-error {
      color: var(--accent);
      font-size: 0.85rem;
      margin-top: 1rem;
      display: none;
    }
    .login-error.show {
      display: block;
    }

    /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
    header {
      background: linear-gradient(135deg, var(--blue-dark) 0%, var(--blue-mid) 100%);
      color: #fff;
      padding: 1.5rem 2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: relative;
      overflow: hidden;
    }
    header::before {
      content: '';
      position: absolute; inset: 0;
      background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.04'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
    }
    .header-content {
      display: flex;
      align-items: center;
      gap: 1.5rem;
      position: relative;
      z-index: 1;
      flex: 1;
    }
    .logo-container {
      flex-shrink: 0;
    }
    .logo-container img {
      height: 60px;
      width: auto;
      object-fit: contain;
    }
    .header-text h1 { font-size: 1.8rem; font-weight: 700; letter-spacing: .5px; margin: 0; }
    .header-text p  { margin: 0.25rem 0 0 0; opacity: .85; font-size: 0.95rem; }


    /* ‚îÄ‚îÄ Nav pills ‚îÄ‚îÄ */
    nav {
      display: flex; justify-content: center; gap: .75rem;
      padding: 1.25rem 1rem;
      background: var(--card);
      box-shadow: 0 2px 8px rgba(31,56,100,.08);
      flex-wrap: wrap;
      position: sticky;
      top: 0;
      z-index: 50;
    }
    nav button {
      background: var(--blue-light);
      color: var(--blue-dark);
      border: none; border-radius: 50px;
      padding: .5rem 1.4rem;
      font-size: .92rem; font-weight: 600;
      cursor: pointer; transition: all .2s;
    }
    nav button:hover, nav button.active {
      background: var(--blue-mid);
      color: #fff;
      box-shadow: 0 4px 12px rgba(46,117,182,.35);
    }

    /* ‚îÄ‚îÄ Main layout ‚îÄ‚îÄ */
    main { max-width: 1200px; margin: 0 auto; padding: 2rem 1.5rem 4rem; }

    /* ‚îÄ‚îÄ KPI Cards ‚îÄ‚îÄ */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1.25rem;
      margin-bottom: 2.5rem;
    }
    .kpi {
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 1.5rem 1.25rem;
      display: flex; flex-direction: column; align-items: center;
      border-top: 4px solid var(--blue-mid);
      transition: transform .2s;
    }
    .kpi:hover { transform: translateY(-4px); }
    .kpi .icon { font-size: 2rem; margin-bottom: .5rem; }
    .kpi .value { font-size: 2.2rem; font-weight: 800; color: var(--blue-dark); }
    .kpi .label { font-size: .82rem; color: var(--muted); text-align: center; margin-top: .25rem; text-transform: uppercase; letter-spacing: .5px; }

    /* ‚îÄ‚îÄ Section ‚îÄ‚îÄ */
    section { display: none; }
    section.active { display: block; }

    /* ‚îÄ‚îÄ Cards ‚îÄ‚îÄ */
    .card {
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 1.75rem;
      margin-bottom: 2rem;
    }
    .card h2 {
      font-size: 1.15rem; font-weight: 700;
      color: var(--blue-dark);
      margin-bottom: 1.25rem;
      padding-bottom: .6rem;
      border-bottom: 2px solid var(--blue-light);
      display: flex; align-items: center; gap: .5rem;
    }

    /* ‚îÄ‚îÄ Chart grid ‚îÄ‚îÄ */
    .chart-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }
    .chart-wrap { position: relative; height: 300px; }

    /* ‚îÄ‚îÄ Buttons ‚îÄ‚îÄ */
    .btn-group {
      display: flex; gap: .75rem; flex-wrap: wrap;
      margin-bottom: 1.5rem;
    }
    button.btn {
      padding: .6rem 1.2rem;
      border: none;
      border-radius: 8px;
      font-size: .92rem;
      font-weight: 600;
      cursor: pointer;
      transition: all .2s;
      display: flex; align-items: center; gap: .4rem;
    }
    button.btn-primary {
      background: var(--blue-mid);
      color: #fff;
    }
    button.btn-primary:hover {
      background: var(--blue-dark);
      box-shadow: 0 4px 12px rgba(31,56,100,.3);
    }
    button.btn-success {
      background: var(--success);
      color: #fff;
    }
    button.btn-success:hover {
      background: #1e8449;
    }
    button.btn-danger {
      background: var(--accent);
      color: #fff;
    }
    button.btn-danger:hover {
      background: #c73535;
    }
    button.btn-secondary {
      background: #95a5a6;
      color: #fff;
    }
    button.btn-secondary:hover {
      background: #7f8c8d;
    }
    button.btn-warning {
      background: var(--warning);
      color: #fff;
    }
    button.btn-warning:hover {
      background: #e0941f;
    }

    /* ‚îÄ‚îÄ Modal ‚îÄ‚îÄ */
    .modal {
      display: none;
      position: fixed; inset: 0;
      background: rgba(0,0,0,.5);
      z-index: 1000;
      align-items: center; justify-content: center;
    }
    .modal.active { display: flex; }
    .modal-content {
      background: var(--card);
      border-radius: var(--radius);
      padding: 2rem;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 10px 40px rgba(0,0,0,.3);
    }
    .modal-content h3 {
      font-size: 1.3rem;
      color: var(--blue-dark);
      margin-bottom: 1.5rem;
    }
    .form-group {
      margin-bottom: 1.25rem;
    }
    .form-group label {
      display: block;
      font-weight: 600;
      margin-bottom: .4rem;
      color: var(--blue-dark);
      font-size: .9rem;
    }
    .form-group input, .form-group select {
      width: 100%;
      padding: .6rem .8rem;
      border: 1.5px solid #c8d6ea;
      border-radius: 8px;
      font-size: .92rem;
      outline: none;
      transition: border-color .2s;
    }
    .form-group input:focus, .form-group select:focus {
      border-color: var(--blue-mid);
      box-shadow: 0 0 0 3px rgba(46,117,182,.1);
    }
    .modal-buttons {
      display: flex; gap: .75rem; justify-content: flex-end;
      margin-top: 1.75rem;
    }

    /* ‚îÄ‚îÄ Table ‚îÄ‚îÄ */
    .table-wrap { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; font-size: .93rem; }
    thead tr { background: var(--blue-dark); color: #fff; }
    thead th { padding: .85rem 1rem; text-align: left; font-weight: 600; white-space: nowrap; }
    tbody tr { border-bottom: 1px solid #e8edf5; transition: background .15s; }
    tbody tr:hover { background: var(--blue-light); }
    tbody td { padding: .75rem 1rem; }
    .badge {
      display: inline-block;
      padding: .3rem .75rem;
      border-radius: 50px;
      font-size: .78rem; font-weight: 700;
      cursor: pointer;
      transition: all .2s;
    }
    .badge-aberto {
      background: #ffeaea; color: var(--accent);
    }
    .badge-aberto:hover {
      background: #ffcccc;
    }
    .badge-parcial {
      background: #fff3cd; color: #856404;
    }
    .badge-parcial:hover {
      background: #ffe69c;
    }
    .badge-concluido {
      background: #d4edda; color: #155724;
    }
    .badge-concluido:hover {
      background: #c3e6cb;
    }
    .action-btns {
      display: flex; gap: .5rem;
    }
    .action-btns button {
      padding: .35rem .6rem;
      font-size: .8rem;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: all .2s;
    }
    .action-btns .edit-btn {
      background: #3498db;
      color: #fff;
    }
    .action-btns .edit-btn:hover {
      background: #2980b9;
    }
    .action-btns .delete-btn {
      background: var(--accent);
      color: #fff;
    }
    .action-btns .delete-btn:hover {
      background: #c73535;
    }

    /* ‚îÄ‚îÄ Search / Filter ‚îÄ‚îÄ */
    .filter-bar {
      display: flex; gap: 1rem; flex-wrap: wrap;
      margin-bottom: 1.25rem;
    }
    .filter-bar input, .filter-bar select {
      padding: .55rem 1rem;
      border: 1.5px solid #c8d6ea;
      border-radius: 8px;
      font-size: .92rem;
      outline: none;
      transition: border-color .2s;
      flex: 1; min-width: 160px;
    }
    .filter-bar input:focus, .filter-bar select:focus { border-color: var(--blue-mid); }

    /* ‚îÄ‚îÄ Progress bars ‚îÄ‚îÄ */
    .progress-list { display: flex; flex-direction: column; gap: 1rem; }
    .progress-item label {
      display: flex; justify-content: space-between;
      font-size: .9rem; font-weight: 600; margin-bottom: .3rem;
      color: var(--blue-dark);
    }
    .progress-track {
      background: var(--blue-light);
      border-radius: 50px; height: 14px; overflow: hidden;
    }
    .progress-fill {
      height: 100%; border-radius: 50px;
      background: linear-gradient(90deg, var(--blue-mid), #5ba4e0);
      transition: width 1s ease;
    }

    /* ‚îÄ‚îÄ Alert ‚îÄ‚îÄ */
    .alert {
      padding: 1rem 1.25rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      display: none;
    }
    .alert.show { display: block; }
    .alert-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .alert-error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    /* ‚îÄ‚îÄ PDF Report ‚îÄ‚îÄ */
    .pdf-report {
      background: #fff;
      padding: 2rem;
      border-radius: var(--radius);
      margin-top: 2rem;
    }
    .pdf-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 2rem;
      padding-bottom: 1rem;
      border-bottom: 3px solid var(--blue-mid);
    }
    .pdf-header img {
      height: 50px;
      width: auto;
    }
    .pdf-header-text {
      flex: 1;
      margin-left: 1rem;
    }
    .pdf-header-text h2 {
      margin: 0;
      color: var(--blue-dark);
      font-size: 1.5rem;
    }
    .pdf-header-text p {
      margin: 0.25rem 0 0 0;
      color: var(--muted);
      font-size: 0.9rem;
    }
    .pdf-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }
    .pdf-stat-box {
      background: var(--blue-light);
      padding: 1.5rem;
      border-radius: 12px;
      border-left: 4px solid var(--blue-mid);
      text-align: center;
    }
    .pdf-stat-box .value {
      font-size: 2.5rem;
      font-weight: 800;
      color: var(--blue-dark);
      display: block;
      margin-bottom: 0.5rem;
    }
    .pdf-stat-box .label {
      font-size: 0.9rem;
      color: var(--muted);
      font-weight: 600;
    }
    .pdf-section {
      margin-bottom: 2rem;
    }
    .pdf-section h3 {
      color: var(--blue-dark);
      font-size: 1.2rem;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid var(--blue-light);
    }

    /* ‚îÄ‚îÄ Footer ‚îÄ‚îÄ */
    footer {
      text-align: center;
      padding: 1.5rem;
      color: var(--muted);
      font-size: .82rem;
      border-top: 1px solid #dde4f0;
      margin-top: 2rem;
    }

    /* ‚îÄ‚îÄ Print ‚îÄ‚îÄ */
    @media print {
      nav, .btn-group, .filter-bar, .logout-btn { display: none !important; }
      .pdf-report { box-shadow: none; border: none; }
    }

    /* ‚îÄ‚îÄ Responsive ‚îÄ‚îÄ */
    @media (max-width: 768px) {
      header {
        flex-direction: column;
        text-align: center;
      }
      .header-content {
        flex-direction: column;
        gap: 1rem;
      }
      .header-text h1 { font-size: 1.4rem; }
      .kpi .value { font-size: 1.7rem; }
      .modal-content { width: 95%; }
      .pdf-header {
        flex-direction: column;
        text-align: center;
      }
      .pdf-header-text {
        margin-left: 0;
        margin-top: 1rem;
      }
      .logout-btn {
        margin-top: 1rem;
        width: 100%;
      }
    }
  </style>
</head>
<body>

<!-- ‚îÄ‚îÄ LOGIN SCREEN ‚îÄ‚îÄ -->
<div id="login-screen">
  <div class="login-container">
    <div class="login-logo">
      <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAABQCAMAAAC5zwKfAAABF1BMVEUAFlD/JzIAFk//JzMAFlKiJkUAEEsADUPPMUQAF1H/KDAAF04AFVIAFFH/JzUAGFAZC0MAEEgADEAAFlXkM0SWJEbGMEgAGE32L0BJGD7/KC0AEkrUMUSzK0AADEXPMUX8LDpyHECGIj0AEE4ADj78Lj0AE1UAGElmHUKxLEPzMUF4IDwmEUAvEjuEJkUACD1wHkNUFz6qM1YTDT/mLjyUJEgvD0HgMEZlHDyrKUgfDj1AF0MVDkeFIkE5F0HHMEyXJj9dJErCIzf3L0ejKj48EzhIGTqEKDxrHDxsI0lcHj3hN1ESDjodGk23KDtSF0SEJk++Lk4gCzFpJFOoO1s5H07WLz1QGjakOmMAAC99I0sVDjiSKDlKEzS5AAAD20lEQVR4nO2Xa4/aRhSG53Iw8Yw9bjGLHezFTmK2C9kgUDbrLBKBNtsWNVWlSlVT7f//IZ2LbYyCytDNp5b3i0HAM+d+BoTOOuuss/67AqmvCvQyJvqL5OtRw0wIjHHpPA1DgHOunAXyDBuNE/cpRIDk5vmHEXJr4FBM/63XBCB6QSu7po2FmI2/4+Yw3z8JyJNZjdsDYvxR2xgWH08DLsUOwWID/EGIHGOxIDKqr4RY89AaFzwK+iXwIdGniIBAIRgVS/t4hl1xwMIO+oWp5wjcXEeCWwMTGLFDQP6jevZDA2Q9a6DMci8W8WS1nU9ihhsgBExaPux5mQaWxLMnyoJ2iX7hvvlUAyOUSsvpCq7Ve8pIYM3jHnHfbtIynY0QJ5AZIEKvVbIGcGeC0SX2QOjdYoqFTM6fXbQPZBlaGuCNbS1y3q5DPEYVEKJ79WISVRZubQsH7mm7bEQNJChX2f/eW5lPVpZJ8de6rJV3upLzJimO5vikb4Bzu16BbWXfdLK5jNvAb3X9rV0YVjG0Sgq81jj2AERVz9UgFzVwLEFUOPzNkGo5NkAAc3oagv566JaNhbkJAH+8MAptkuLfaN41+KBFAvLZq5KiTGejgHhQKzqODGINfJbW+oNAA5R52oRup9+ovDhuYrsCsWAFJ24TQyrWyP+99Q26Ocrr7gOvuP+wSwqe+d779mjDz48CF20c/ilKZqxJCu4Q7uwdSEdHgZ3WJBT3PgwwboAyGUu8DzzezbN0p1mIOvJHDZCQv7JBLX1wfHxqE7nKvUooHA3bwEUEnKgdJcv1hbZwadUr7qXW5B0huerqXWH3XU0jEOhuFsIGh0jCtPA3kcOG7V7OaepzCfTdtRkbcysgqqYdc71L9RwXQQ2UCcmzySDWiaHi/ZWdhY8GWKJE2+FAG0ixtF2PNzGx3CnknQGuyEJHMNoB28tVXER2DiO0NT+5g0u14ybQAON208metOS5Zt7I8TmgJvA10HfWQ+UyY2kB9jsZzKDHHwINfNwBQ/nZ9W/ZYDVyOVg7LGcq00Gfw89qraReAywXLhCuC9FqtlYiQaaDn0FPxVCAVwOnjOaDi5cbuRXi4pS7bM+EnfBb9fzMoU5KayyIEbdHQqkLOgBNpttDQIoL+zss+VUwJgpCAuW7YE72JZDhrb3LIZkI8UqFf6EuwVTcHgD2wP5KLJFlYSbdFDeXY5mUxt/hPDqhbJTTYaSBPBjjFrDqlHwB4J8GbKGneQME1L25e+t4T/rTFyRjWgPlMJSbndhfMw8LklKlGndO+6vzD8AIkkVfsM5TLTvrrLPO+l/pbxy/TECdRLkeAAAAAElFTkSuQmCC" alt="Plano & Plano" />
    </div>
    <h1>Acesso Restrito</h1>
    <p>Fa√ßa login para acessar o controle de materiais</p>
    <form class="login-form" onsubmit="auth.login(event)">
      <div class="form-group">
        <label for="login-input">Login</label>
        <input type="text" id="login-input" required autocomplete="off" />
      </div>
      <div class="form-group">
        <label for="password-input">Senha</label>
        <div style="display: flex; gap: 0.5rem; align-items: center;">
          <input type="password" id="password-input" placeholder="Digite sua senha" required autocomplete="off" style="flex: 1;" />
          <button type="button" onclick="auth.toggleSenha()" style="padding: 0.6rem 0.8rem; background: #ddeeff; border: 1px solid #c8d6ea; border-radius: 8px; cursor: pointer; font-size: 1rem;">üëÅÔ∏è</button>
        </div>
      </div>
      <button type="submit">Acessar Sistema</button>
      <div id="login-error" class="login-error">‚ùå Login ou senha incorretos! Tente novamente.</div>
    </form>
  </div>
</div>

<!-- ‚îÄ‚îÄ MAIN APP ‚îÄ‚îÄ -->
<header>
  <div class="header-content">
    <div class="logo-container">
      <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAABQCAMAAAC5zwKfAAABF1BMVEUAFlD/JzIAFk//JzMAFlKiJkUAEEsADUPPMUQAF1H/KDAAF04AFVIAFFH/JzUAGFAZC0MAEEgADEAAFlXkM0SWJEbGMEgAGE32L0BJGD7/KC0AEkrUMUSzK0AADEXPMUX8LDpyHECGIj0AEE4ADj78Lj0AE1UAGElmHUKxLEPzMUF4IDwmEUAvEjuEJkUACD1wHkNUFz6qM1YTDT/mLjyUJEgvD0HgMEZlHDyrKUgfDj1AF0MVDkeFIkE5F0HHMEyXJj9dJErCIzf3L0ejKj48EzhIGTqEKDxrHDxsI0lcHj3hN1ESDjodGk23KDtSF0SEJk++Lk4gCzFpJFOoO1s5H07WLz1QGjakOmMAAC99I0sVDjiSKDlKEzS5AAAD20lEQVR4nO2Xa4/aRhSG53Iw8Yw9bjGLHezFTmK2C9kgUDbrLBKBNtsWNVWlSlVT7f//IZ2LbYyCytDNp5b3i0HAM+d+BoTOOuuss/67AqmvCvQyJvqL5OtRw0wIjHHpPA1DgHOunAXyDBuNE/cpRIDk5vmHEXJr4FBM/63XBCB6QSu7po2FmI2/4+Yw3z8JyJNZjdsDYvxR2xgWH08DLsUOwWID/EGIHGOxIDKqr4RY89AaFzwK+iXwIdGniIBAIRgVS/t4hl1xwMIO+oWp5wjcXEeCWwMTGLFDQP6jevZDA2Q9a6DMci8W8WS1nU9ihhsgBExaPux5mQaWxLMnyoJ2iX7hvvlUAyOUSsvpCq7Ve8pIYM3jHnHfbtIynY0QJ5AZIEKvVbIGcGeC0SX2QOjdYoqFTM6fXbQPZBlaGuCNbS1y3q5DPEYVEKJ79WISVRZubQsH7mm7bEQNJChX2f/eW5lPVpZJ8de6rJV3upLzJimO5vikb4Bzu16BbWXfdLK5jNvAb3X9rV0YVjG0Sgq81jj2AERVz9UgFzVwLEFUOPzNkGo5NkAAc3oagv566JaNhbkJAH+8MAptkuLfaN41+KBFAvLZq5KiTGejgHhQKzqODGINfJbW+oNAA5R52oRup9+ovDhuYrsCsWAFJ24TQyrWyP+99Q26Ocrr7gOvuP+wSwqe+d779mjDz48CF20c/ilKZqxJCu4Q7uwdSEdHgZ3WJBT3PgwwboAyGUu8DzzezbN0p1mIOvJHDZCQv7JBLX1wfHxqE7nKvUooHA3bwEUEnKgdJcv1hbZwadUr7qXW5B0huerqXWH3XU0jEOhuFsIGh0jCtPA3kcOG7V7OaepzCfTdtRkbcysgqqYdc71L9RwXQQ2UCcmzySDWiaHi/ZWdhY8GWKJE2+FAG0ixtF2PNzGx3CnknQGuyEJHMNoB28tVXER2DiO0NT+5g0u14ybQAON208metOS5Zt7I8TmgJvA10HfWQ+UyY2kB9jsZzKDHHwINfNwBQ/nZ9W/ZYDVyOVg7LGcq00Gfw89qraReAywXLhCuC9FqtlYiQaaDn0FPxVCAVwOnjOaDi5cbuRXi4pS7bM+EnfBb9fzMoU5KayyIEbdHQqkLOgBNpttDQIoL+zss+VUwJgpCAuW7YE72JZDhrb3LIZkI8UqFf6EuwVTcHgD2wP5KLJFlYSbdFDeXY5mUxt/hPDqhbJTTYaSBPBjjFrDqlHwB4J8GbKGneQME1L25e+t4T/rTFyRjWgPlMJSbndhfMw8LklKlGndO+6vzD8AIkkVfsM5TLTvrrLPO+l/pbxy/TECdRLkeAAAAAElFTkSuQmCC" alt="Plano & Plano" />
    </div>
    <div class="header-text">
      <h1>Controle de Materiais</h1>
      <p>Gest√£o profissional de empr√©stimos - Plano & Plano</p>
    </div>
  </div>

</header>

<nav>
  <button class="active" onclick="app.showSection('visao-geral', this)">Vis√£o Geral</button>
  <button onclick="app.showSection('por-empresa', this)">Por Empresa</button>
  <button onclick="app.showSection('por-material', this)">Por Material</button>
  <button onclick="app.showSection('registros', this)">Gerenciar Registros</button>
  <button onclick="app.showSection('relatorio', this)">Relat√≥rio Visual</button>
</nav>

<main>

  <!-- Alert ‚îÄ‚îÄ -->
  <div id="alert" class="alert"></div>

  <!-- KPIs sempre vis√≠veis -->
  <div class="kpi-grid">
    <div class="kpi">
      <div class="icon">üìã</div>
      <div class="value" id="kpiTotal">660</div>
      <div class="label">Total de Itens em D√©bito</div>
    </div>
    <div class="kpi">
      <div class="icon">üè¢</div>
      <div class="value" id="kpiEmpresas">4</div>
      <div class="label">Empresas Credoras</div>
    </div>
    <div class="kpi">
      <div class="icon">üî®</div>
      <div class="value" id="kpiMateriais">4</div>
      <div class="label">Tipos de Material</div>
    </div>
    <div class="kpi">
      <div class="icon">üìÖ</div>
      <div class="value" id="kpiRegistros">7</div>
      <div class="label">Registros de Empr√©stimo</div>
    </div>
    <div class="kpi" style="border-top-color: var(--accent);">
      <div class="icon">‚ö†Ô∏è</div>
      <div class="value" id="kpiAbertos" style="color:var(--accent);">7</div>
      <div class="label">Itens Em Aberto</div>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ VIS√ÉO GERAL ‚îÄ‚îÄ -->
  <section id="visao-geral" class="active">
    <div class="chart-grid">
      <div class="card">
        <h2>üìä Quantidade por Empresa</h2>
        <div class="chart-wrap"><canvas id="chartEmpresa"></canvas></div>
      </div>
      <div class="card">
        <h2>üèóÔ∏è Distribui√ß√£o por Material</h2>
        <div class="chart-wrap"><canvas id="chartMaterial"></canvas></div>
      </div>
    </div>
    <div class="card">
      <h2>üìà Empr√©stimos por Data</h2>
      <div class="chart-wrap" style="height:260px"><canvas id="chartData"></canvas></div>
    </div>
  </section>

  <!-- ‚îÄ‚îÄ POR EMPRESA ‚îÄ‚îÄ -->
  <section id="por-empresa">
    <div class="card">
      <h2>üè¢ Participa√ß√£o por Empresa</h2>
      <div class="progress-list" id="progressEmpresas"></div>
    </div>
    <div class="card">
      <h2>üìà Comparativo de Empresas</h2>
      <div class="chart-wrap" style="height:320px"><canvas id="chartEmpresaBar"></canvas></div>
    </div>
  </section>

  <!-- ‚îÄ‚îÄ POR MATERIAL ‚îÄ‚îÄ -->
  <section id="por-material">
    <div class="card">
      <h2>üî® Participa√ß√£o por Material</h2>
      <div class="progress-list" id="progressMateriais"></div>
    </div>
    <div class="card">
      <h2>üìà Comparativo de Materiais</h2>
      <div class="chart-wrap" style="height:300px"><canvas id="chartMaterialBar"></canvas></div>
    </div>
  </section>

  <!-- ‚îÄ‚îÄ REGISTROS ‚îÄ‚îÄ -->
  <section id="registros">
    <div class="card">
      <h2>üìù Gerenciar Registros</h2>
      <div class="btn-group">
        <button class="btn btn-primary" onclick="app.abrirModalNovo()">
          ‚ûï Novo Registro
        </button>
        <button class="btn btn-success" onclick="app.exportarCSV()">
          üíæ Exportar CSV
        </button>
        <button class="btn btn-warning" onclick="app.showSection('relatorio', document.querySelectorAll('nav button')[4])">
          üìä Gerar Relat√≥rio
        </button>
        <button class="btn btn-secondary" onclick="app.resetarDados()">
          üîÑ Resetar Dados
        </button>
      </div>
      <div class="filter-bar">
        <input type="text" id="searchInput" placeholder="üîç Buscar por empresa ou material..." oninput="app.filtrarTabela()" />
        <select id="filterEmpresa" onchange="app.filtrarTabela()">
          <option value="">Todas as empresas</option>
        </select>
        <select id="filterMaterial" onchange="app.filtrarTabela()">
          <option value="">Todos os materiais</option>
        </select>
        <select id="filterStatus" onchange="app.filtrarTabela()">
          <option value="">Todos os status</option>
          <option value="Em Aberto">Em Aberto</option>
          <option value="Parcial">Parcial</option>
          <option value="Conclu√≠do">Conclu√≠do</option>
        </select>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Empresa</th>
              <th>Material</th>
              <th>Data do Empr√©stimo</th>
              <th>Quantidade</th>
              <th>Status (Clique para mudar)</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody id="tabelaRegistros"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- ‚îÄ‚îÄ RELAT√ìRIO VISUAL ‚îÄ‚îÄ -->
  <section id="relatorio">
    <div class="card">
      <h2>üìä Relat√≥rio Visual para Apresenta√ß√£o</h2>
      <div class="btn-group">
        <button class="btn btn-success" onclick="app.exportarPDF()">
          üì• Baixar Relat√≥rio PDF
        </button>
        <button class="btn btn-secondary" onclick="window.print()">
          üñ®Ô∏è Imprimir
        </button>
      </div>
      <div id="pdf-container" class="pdf-report">
        <!-- Relat√≥rio ser√° gerado aqui -->
      </div>
    </div>
  </section>

</main>

<!-- ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ -->
<div id="modal" class="modal">
  <div class="modal-content">
    <h3 id="modalTitle">Novo Registro</h3>
    <form id="formRegistro" onsubmit="app.salvarRegistro(event)">
      <div class="form-group">
        <label for="empresa">Empresa *</label>
        <input type="text" id="empresa" required placeholder="Ex: Felipe Agosti" />
      </div>
      <div class="form-group">
        <label for="material">Material *</label>
        <input type="text" id="material" required placeholder="Ex: Pontalete" />
      </div>
      <div class="form-group">
        <label for="data">Data do Empr√©stimo *</label>
        <input type="date" id="data" required />
      </div>
      <div class="form-group">
        <label for="quantidade">Quantidade *</label>
        <input type="number" id="quantidade" required min="1" placeholder="Ex: 20" />
      </div>
      <div class="modal-buttons">
        <button type="button" class="btn btn-secondary" onclick="app.fecharModal()">Cancelar</button>
        <button type="submit" class="btn btn-success">Salvar</button>
      </div>
    </form>
  </div>
</div>

<footer>
  Controle de Materiais de Empr√©stimo ‚Äî Plano & Plano &mdash; Dados salvos automaticamente
</footer>

<script>
// ‚îÄ‚îÄ AUTENTICA√á√ÉO ‚îÄ‚îÄ
const auth = {
  CREDENCIAIS: {
    login: 'planonana',
    senha: '@plano123'
  },
  SESSION_KEY: 'plano_session_auth',

  verificarSessao() {
    // Sempre mostrar a tela de login ao carregar
    document.getElementById('login-screen').classList.remove('hidden');
    document.querySelector('header').style.display = 'none';
    document.querySelector('nav').style.display = 'none';
    document.querySelector('main').style.display = 'none';
    document.querySelector('footer').style.display = 'none';
  },

  login(e) {
    e.preventDefault();
    const login = document.getElementById('login-input').value.toLowerCase().trim();
    const senha = document.getElementById('password-input').value.trim();



    if (login === this.CREDENCIAIS.login && senha === this.CREDENCIAIS.senha) {
      document.getElementById('login-error').classList.remove('show');
      this.mostrarApp();
    } else {
      document.getElementById('login-error').classList.add('show');
      document.getElementById('password-input').value = '';
      document.getElementById('login-input').focus();
    }
  },



  toggleSenha() {
    const input = document.getElementById('password-input');
    if (input.type === 'password') {
      input.type = 'text';
    } else {
      input.type = 'password';
    }
  },

  mostrarApp() {
    document.getElementById('login-screen').classList.add('hidden');
    document.querySelector('header').style.display = 'flex';
    document.querySelector('nav').style.display = 'flex';
    document.querySelector('main').style.display = 'block';
    document.querySelector('footer').style.display = 'block';
    app.init();
  }
};

// ‚îÄ‚îÄ Aplica√ß√£o Principal ‚îÄ‚îÄ
const app = {
  STORAGE_KEY: 'controle_emprestimos_dados_final',
  CORES: ["#2E75B6","#1F3864","#5BA4E0","#E84545","#F5A623","#27AE60","#8E44AD"],
  dados: [],
  editandoId: null,
  charts: {},

  // ‚îÄ‚îÄ Inicializa√ß√£o ‚îÄ‚îÄ
  init() {
    console.log('Inicializando aplica√ß√£o...');
    this.carregarDados();
    this.atualizarUI();
    this.setupEventListeners();
    console.log('Aplica√ß√£o inicializada com sucesso!');
  },

  // ‚îÄ‚îÄ Setup de eventos ‚îÄ‚îÄ
  setupEventListeners() {
    const modal = document.getElementById('modal');
    modal.addEventListener('click', (e) => {
      if (e.target.id === 'modal') this.fecharModal();
    });
  },

  // ‚îÄ‚îÄ Carregar dados ‚îÄ‚îÄ
  carregarDados() {
    try {
      const salvos = localStorage.getItem(this.STORAGE_KEY);
      if (salvos) {
        this.dados = JSON.parse(salvos);
        console.log('Dados carregados do localStorage:', this.dados.length, 'registros');
      } else {
        this.dados = [
          { id:1, empresa:"Felipe Agosti", material:"Pontalete",              data:"2026-01-28", quantidade:20,  status:"Em Aberto" },
          { id:2, empresa:"Felipe Agosti", material:"Chapa de Madeirite OSB", data:"2026-01-28", quantidade:20,  status:"Em Aberto" },
          { id:3, empresa:"Felipe Agosti", material:"Pontalete",              data:"2026-02-12", quantidade:150, status:"Em Aberto" },
          { id:4, empresa:"Felipe Agosti", material:"T√°bua 30cm",             data:"2026-02-12", quantidade:50,  status:"Em Aberto" },
          { id:5, empresa:"Murilo",        material:"Pontalete",              data:"2026-02-04", quantidade:220, status:"Em Aberto" },
          { id:6, empresa:"Spera Urban",   material:"Pontalete",              data:"2025-02-03", quantidade:100, status:"Em Aberto" },
          { id:7, empresa:"Plano Purus",   material:"T√°bua de 30cm",          data:"2026-02-06", quantidade:100, status:"Em Aberto" },
        ];
        this.salvarDados();
      }
    } catch (e) {
      console.error('Erro ao carregar dados:', e);
      this.mostrarAlerta('Erro ao carregar dados. Usando dados padr√£o.', 'error');
    }
  },

  // ‚îÄ‚îÄ Salvar dados ‚îÄ‚îÄ
  salvarDados() {
    try {
      localStorage.setItem(this.STORAGE_KEY, JSON.stringify(this.dados));
      console.log('Dados salvos com sucesso!');
    } catch (e) {
      console.error('Erro ao salvar dados:', e);
      this.mostrarAlerta('Erro ao salvar dados. Tente novamente.', 'error');
    }
  },

  // ‚îÄ‚îÄ Alert ‚îÄ‚îÄ
  mostrarAlerta(msg, tipo) {
    const alert = document.getElementById('alert');
    alert.textContent = msg;
    alert.className = `alert show alert-${tipo}`;
    setTimeout(() => alert.classList.remove('show'), 3000);
  },

  // ‚îÄ‚îÄ Navega√ß√£o ‚îÄ‚îÄ
  showSection(id, btn) {
    document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
    document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    btn.classList.add('active');
    
    if (id === 'relatorio') {
      this.gerarRelatorioPDF();
    }
  },

  // ‚îÄ‚îÄ Modal ‚îÄ‚îÄ
  abrirModalNovo() {
    this.editandoId = null;
    document.getElementById('modalTitle').textContent = 'Novo Registro';
    document.getElementById('formRegistro').reset();
    document.getElementById('modal').classList.add('active');
  },

  abrirModalEditar(id) {
    const reg = this.dados.find(d => d.id === id);
    if (!reg) return;
    this.editandoId = id;
    document.getElementById('modalTitle').textContent = 'Editar Registro';
    document.getElementById('empresa').value = reg.empresa;
    document.getElementById('material').value = reg.material;
    document.getElementById('data').value = reg.data;
    document.getElementById('quantidade').value = reg.quantidade;
    document.getElementById('modal').classList.add('active');
  },

  fecharModal() {
    document.getElementById('modal').classList.remove('active');
    this.editandoId = null;
  },

  salvarRegistro(e) {
    e.preventDefault();
    const empresa = document.getElementById('empresa').value.trim();
    const material = document.getElementById('material').value.trim();
    const data = document.getElementById('data').value;
    const quantidade = parseInt(document.getElementById('quantidade').value);

    if (!empresa || !material || !data || !quantidade) {
      this.mostrarAlerta('Preencha todos os campos!', 'error');
      return;
    }

    if (this.editandoId) {
      const idx = this.dados.findIndex(d => d.id === this.editandoId);
      if (idx !== -1) {
        this.dados[idx] = { id: this.editandoId, empresa, material, data, quantidade, status: this.dados[idx].status };
      }
    } else {
      const novoId = Math.max(...this.dados.map(d => d.id), 0) + 1;
      this.dados.push({ id: novoId, empresa, material, data, quantidade, status: "Em Aberto" });
    }

    this.fecharModal();
    this.salvarDados();
    this.atualizarUI();
    this.mostrarAlerta('Registro salvo com sucesso!', 'success');
  },

  deletarRegistro(id) {
    if (confirm('Tem certeza que deseja deletar este registro?')) {
      this.dados = this.dados.filter(d => d.id !== id);
      this.salvarDados();
      this.atualizarUI();
      this.mostrarAlerta('Registro deletado com sucesso!', 'success');
    }
  },

  alterarStatus(id) {
    const reg = this.dados.find(d => d.id === id);
    if (!reg) return;
    
    const statusOpcoes = ["Em Aberto", "Parcial", "Conclu√≠do"];
    const indiceAtual = statusOpcoes.indexOf(reg.status);
    reg.status = statusOpcoes[(indiceAtual + 1) % statusOpcoes.length];
    
    this.salvarDados();
    this.atualizarUI();
    this.mostrarAlerta(`Status alterado para: ${reg.status}`, 'success');
  },

  // ‚îÄ‚îÄ Agregar ‚îÄ‚îÄ
  agrupar(campo) {
    return this.dados.reduce((acc, d) => {
      acc[d[campo]] = (acc[d[campo]] || 0) + d.quantidade;
      return acc;
    }, {});
  },

  // ‚îÄ‚îÄ Atualizar UI ‚îÄ‚îÄ
  atualizarUI() {
    const porEmpresa  = this.agrupar('empresa');
    const porMaterial = this.agrupar('material');
    const total = this.dados.reduce((s, d) => s + d.quantidade, 0);

    // KPIs
    document.getElementById('kpiTotal').textContent = total;
    document.getElementById('kpiEmpresas').textContent = Object.keys(porEmpresa).length;
    document.getElementById('kpiMateriais').textContent = Object.keys(porMaterial).length;
    document.getElementById('kpiRegistros').textContent = this.dados.length;
    document.getElementById('kpiAbertos').textContent = this.dados.filter(d => d.status === "Em Aberto").length;

    // Filtros
    const filterEmp = document.getElementById('filterEmpresa');
    const filterMat = document.getElementById('filterMaterial');
    const empresasAtuais = new Set(this.dados.map(d => d.empresa));
    const materiaisAtuais = new Set(this.dados.map(d => d.material));

    filterEmp.innerHTML = '<option value="">Todas as empresas</option>';
    [...empresasAtuais].sort().forEach(e => {
      filterEmp.innerHTML += `<option>${e}</option>`;
    });

    filterMat.innerHTML = '<option value="">Todos os materiais</option>';
    [...materiaisAtuais].sort().forEach(m => {
      filterMat.innerHTML += `<option>${m}</option>`;
    });

    // Tabela
    this.renderTabela(this.dados);

    // Gr√°ficos
    this.atualizarGraficos(porEmpresa, porMaterial, total);
  },

  // ‚îÄ‚îÄ Tabela ‚îÄ‚îÄ
  renderTabela(lista) {
    const tbody = document.getElementById('tabelaRegistros');
    tbody.innerHTML = lista.map(d => {
      const dataFormatada = new Date(d.data + 'T00:00:00').toLocaleDateString('pt-BR');
      const statusClass = `badge-${d.status.toLowerCase().replace('√°', 'a').replace('√≠', 'i')}`;
      return `
        <tr>
          <td>${d.id}</td>
          <td><strong>${d.empresa}</strong></td>
          <td>${d.material}</td>
          <td>${dataFormatada}</td>
          <td><strong>${d.quantidade}</strong></td>
          <td><span class="badge ${statusClass}" onclick="app.alterarStatus(${d.id})" title="Clique para mudar status">${d.status}</span></td>
          <td>
            <div class="action-btns">
              <button class="edit-btn" onclick="app.abrirModalEditar(${d.id})">‚úèÔ∏è Editar</button>
              <button class="delete-btn" onclick="app.deletarRegistro(${d.id})">üóëÔ∏è Deletar</button>
            </div>
          </td>
        </tr>`;
    }).join('');
  },

  filtrarTabela() {
    const busca    = document.getElementById('searchInput').value.toLowerCase();
    const empresa  = document.getElementById('filterEmpresa').value;
    const material = document.getElementById('filterMaterial').value;
    const status   = document.getElementById('filterStatus').value;
    const filtrado = this.dados.filter(d => {
      const matchBusca   = !busca   || d.empresa.toLowerCase().includes(busca) || d.material.toLowerCase().includes(busca);
      const matchEmpresa = !empresa || d.empresa === empresa;
      const matchMat     = !material|| d.material.toLowerCase().includes(material.toLowerCase());
      const matchStatus  = !status  || d.status === status;
      return matchBusca && matchEmpresa && matchMat && matchStatus;
    });
    this.renderTabela(filtrado);
  },

  // ‚îÄ‚îÄ Gr√°ficos ‚îÄ‚îÄ
  atualizarGraficos(porEmpresa, porMaterial, total) {
    // Destruir gr√°ficos antigos
    Object.values(this.charts).forEach(chart => {
      try { chart.destroy(); } catch(e) {}
    });
    this.charts = {};

    // Gr√°fico: Empresa (doughnut)
    this.charts.empresa = new Chart(document.getElementById('chartEmpresa'), {
      type: 'doughnut',
      data: {
        labels: Object.keys(porEmpresa),
        datasets: [{ data: Object.values(porEmpresa), backgroundColor: this.CORES, borderWidth: 2, borderColor: '#fff' }]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: {
          legend: { position: 'bottom', labels: { padding: 16, font: { size: 12 } } },
          tooltip: { callbacks: { label: ctx => ` ${ctx.label}: ${ctx.raw} itens (${(ctx.raw/total*100).toFixed(1)}%)` } }
        },
        cutout: '60%'
      }
    });

    // Gr√°fico: Material (pie)
    this.charts.material = new Chart(document.getElementById('chartMaterial'), {
      type: 'pie',
      data: {
        labels: Object.keys(porMaterial),
        datasets: [{ data: Object.values(porMaterial), backgroundColor: this.CORES, borderWidth: 2, borderColor: '#fff' }]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: {
          legend: { position: 'bottom', labels: { padding: 14, font: { size: 12 } } },
          tooltip: { callbacks: { label: ctx => ` ${ctx.label}: ${ctx.raw} itens (${(ctx.raw/total*100).toFixed(1)}%)` } }
        }
      }
    });

    // Gr√°fico: Por data
    const porData = this.dados.reduce((acc, d) => {
      const key = `${d.data} ‚Äì ${d.empresa}`;
      acc[key] = (acc[key] || 0) + d.quantidade;
      return acc;
    }, {});
    this.charts.data = new Chart(document.getElementById('chartData'), {
      type: 'bar',
      data: {
        labels: Object.keys(porData),
        datasets: [{
          label: 'Quantidade',
          data: Object.values(porData),
          backgroundColor: this.CORES,
          borderRadius: 8,
          borderSkipped: false
        }]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          x: { ticks: { font: { size: 10 }, maxRotation: 30 }, grid: { display: false } },
          y: { beginAtZero: true, grid: { color: '#e8edf5' } }
        }
      }
    });

    // Gr√°fico: Empresa bar
    this.charts.empresaBar = new Chart(document.getElementById('chartEmpresaBar'), {
      type: 'bar',
      data: {
        labels: Object.keys(porEmpresa),
        datasets: [{
          label: 'Total de Itens',
          data: Object.values(porEmpresa),
          backgroundColor: this.CORES,
          borderRadius: 10,
          borderSkipped: false
        }]
      },
      options: {
        indexAxis: 'y',
        responsive: true, maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          x: { beginAtZero: true, grid: { color: '#e8edf5' } },
          y: { grid: { display: false } }
        }
      }
    });

    // Gr√°fico: Material bar
    this.charts.materialBar = new Chart(document.getElementById('chartMaterialBar'), {
      type: 'bar',
      data: {
        labels: Object.keys(porMaterial),
        datasets: [{
          label: 'Total de Itens',
          data: Object.values(porMaterial),
          backgroundColor: this.CORES,
          borderRadius: 10,
          borderSkipped: false
        }]
      },
      options: {
        indexAxis: 'y',
        responsive: true, maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          x: { beginAtZero: true, grid: { color: '#e8edf5' } },
          y: { grid: { display: false } }
        }
      }
    });

    // Progress bars: Empresas
    const peDiv = document.getElementById('progressEmpresas');
    peDiv.innerHTML = '';
    Object.entries(porEmpresa).sort((a,b) => b[1]-a[1]).forEach(([emp, qtd], i) => {
      const pct = (qtd/total*100).toFixed(1);
      peDiv.innerHTML += `
        <div class="progress-item">
          <label><span>${emp}</span><span>${qtd} itens (${pct}%)</span></label>
          <div class="progress-track">
            <div class="progress-fill" style="width:${pct}%; background: linear-gradient(90deg, ${this.CORES[i]}, ${this.CORES[(i+1)%this.CORES.length]})"></div>
          </div>
        </div>`;
    });

    // Progress bars: Materiais
    const pmDiv = document.getElementById('progressMateriais');
    pmDiv.innerHTML = '';
    Object.entries(porMaterial).sort((a,b) => b[1]-a[1]).forEach(([mat, qtd], i) => {
      const pct = (qtd/total*100).toFixed(1);
      pmDiv.innerHTML += `
        <div class="progress-item">
          <label><span>${mat}</span><span>${qtd} itens (${pct}%)</span></label>
          <div class="progress-track">
            <div class="progress-fill" style="width:${pct}%; background: linear-gradient(90deg, ${this.CORES[i]}, ${this.CORES[(i+1)%this.CORES.length]})"></div>
          </div>
        </div>`;
    });
  },

  // ‚îÄ‚îÄ Gerar Relat√≥rio PDF ‚îÄ‚îÄ
  gerarRelatorioPDF() {
    const porEmpresa  = this.agrupar('empresa');
    const porMaterial = this.agrupar('material');
    const total = this.dados.reduce((s, d) => s + d.quantidade, 0);
    const abertos = this.dados.filter(d => d.status === "Em Aberto").length;
    const parciais = this.dados.filter(d => d.status === "Parcial").length;
    const concluidos = this.dados.filter(d => d.status === "Conclu√≠do").length;

    let html = `
      <div class="pdf-header">
        <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAABQCAMAAAC5zwKfAAABF1BMVEUAFlD/JzIAFk//JzMAFlKiJkUAEEsADUPPMUQAF1H/KDAAF04AFVIAFFH/JzUAGFAZC0MAEEgADEAAFlXkM0SWJEbGMEgAGE32L0BJGD7/KC0AEkrUMUSzK0AADEXPMUX8LDpyHECGIj0AEE4ADj78Lj0AE1UAGElmHUKxLEPzMUF4IDwmEUAvEjuEJkUACD1wHkNUFz6qM1YTDT/mLjyUJEgvD0HgMEZlHDyrKUgfDj1AF0MVDkeFIkE5F0HHMEyXJj9dJErCIzf3L0ejKj48EzhIGTqEKDxrHDxsI0lcHj3hN1ESDjodGk23KDtSF0SEJk++Lk4gCzFpJFOoO1s5H07WLz1QGjakOmMAAC99I0sVDjiSKDlKEzS5AAAD20lEQVR4nO2Xa4/aRhSG53Iw8Yw9bjGLHezFTmK2C9kgUDbrLBKBNtsWNVWlSlVT7f//IZ2LbYyCytDNp5b3i0HAM+d+BoTOOuuss/67AqmvCvQyJvqL5OtRw0wIjHHpPA1DgHOunAXyDBuNE/cpRIDk5vmHEXJr4FBM/63XBCB6QSu7po2FmI2/4+Yw3z8JyJNZjdsDYvxR2xgWH08DLsUOwWID/EGIHGOxIDKqr4RY89AaFzwK+iXwIdGniIBAIRgVS/t4hl1xwMIO+oWp5wjcXEeCWwMTGLFDQP6jevZDA2Q9a6DMci8W8WS1nU9ihhsgBExaPux5mQaWxLMnyoJ2iX7hvvlUAyOUSsvpCq7Ve8pIYM3jHnHfbtIynY0QJ5AZIEKvVbIGcGeC0SX2QOjdYoqFTM6fXbQPZBlaGuCNbS1y3q5DPEYVEKJ79WISVRZubQsH7mm7bEQNJChX2f/eW5lPVpZJ8de6rJV3upLzJimO5vikb4Bzu16BbWXfdLK5jNvAb3X9rV0YVjG0Sgq81jj2AERVz9UgFzVwLEFUOPzNkGo5NkAAc3oagv566JaNhbkJAH+8MAptkuLfaN41+KBFAvLZq5KiTGejgHhQKzqODGINfJbW+oNAA5R52oRup9+ovDhuYrsCsWAFJ24TQyrWyP+99Q26Ocrr7gOvuP+wSwqe+d779mjDz48CF20c/ilKZqxJCu4Q7uwdSEdHgZ3WJBT3PgwwboAyGUu8DzzezbN0p1mIOvJHDZCQv7JBLX1wfHxqE7nKvUooHA3bwEUEnKgdJcv1hbZwadUr7qXW5B0huerqXWH3XU0jEOhuFsIGh0jCtPA3kcOG7V7OaepzCfTdtRkbcysgqqYdc71L9RwXQQ2UCcmzySDWiaHi/ZWdhY8GWKJE2+FAG0ixtF2PNzGx3CnknQGuyEJHMNoB28tVXER2DiO0NT+5g0u14ybQAON208metOS5Zt7I8TmgJvA10HfWQ+UyY2kB9jsZzKDHHwINfNwBQ/nZ9W/ZYDVyOVg7LGcq00Gfw89qraReAywXLhCuC9FqtlYiQaaDn0FPxVCAVwOnjOaDi5cbuRXi4pS7bM+EnfBb9fzMoU5KayyIEbdHQqkLOgBNpttDQIoL+zss+VUwJgpCAuW7YE72JZDhrb3LIZkI8UqFf6EuwVTcHgD2wP5KLJFlYSbdFDeXY5mUxt/hPDqhbJTTYaSBPBjjFrDqlHwB4J8GbKGneQME1L25e+t4T/rTFyRjWgPlMJSbndhfMw8LklKlGndO+6vzD8AIkkVfsM5TLTvrrLPO+l/pbxy/TECdRLkeAAAAAElFTkSuQmCC" alt="Plano & Plano" />
        <div class="pdf-header-text">
          <h2>Relat√≥rio de Materiais em Empr√©stimo</h2>
          <p>Gerado em: ${new Date().toLocaleDateString('pt-BR')} √†s ${new Date().toLocaleTimeString('pt-BR')}</p>
        </div>
      </div>

      <div class="pdf-stats">
        <div class="pdf-stat-box">
          <span class="value">${total}</span>
          <span class="label">Total de Itens</span>
        </div>
        <div class="pdf-stat-box">
          <span class="value">${abertos}</span>
          <span class="label">Em Aberto</span>
        </div>
        <div class="pdf-stat-box">
          <span class="value">${parciais}</span>
          <span class="label">Parcial</span>
        </div>
        <div class="pdf-stat-box">
          <span class="value">${concluidos}</span>
          <span class="label">Conclu√≠do</span>
        </div>
      </div>

      <div class="pdf-section">
        <h3>Principais Empresas Credoras</h3>
        <table style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr style="background: #1F3864; color: #fff;">
              <th style="padding: 0.75rem; text-align: left; border: 1px solid #ddd;">Empresa</th>
              <th style="padding: 0.75rem; text-align: center; border: 1px solid #ddd;">Quantidade</th>
              <th style="padding: 0.75rem; text-align: center; border: 1px solid #ddd;">Percentual</th>
            </tr>
          </thead>
          <tbody>
            ${Object.entries(porEmpresa).sort((a,b) => b[1]-a[1]).map(([emp, qtd]) => `
              <tr>
                <td style="padding: 0.75rem; border: 1px solid #ddd;">${emp}</td>
                <td style="padding: 0.75rem; text-align: center; border: 1px solid #ddd;"><strong>${qtd}</strong></td>
                <td style="padding: 0.75rem; text-align: center; border: 1px solid #ddd;">${(qtd/total*100).toFixed(1)}%</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>

      <div class="pdf-section">
        <h3>Materiais em Circula√ß√£o</h3>
        <table style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr style="background: #1F3864; color: #fff;">
              <th style="padding: 0.75rem; text-align: left; border: 1px solid #ddd;">Material</th>
              <th style="padding: 0.75rem; text-align: center; border: 1px solid #ddd;">Quantidade</th>
              <th style="padding: 0.75rem; text-align: center; border: 1px solid #ddd;">Percentual</th>
            </tr>
          </thead>
          <tbody>
            ${Object.entries(porMaterial).sort((a,b) => b[1]-a[1]).map(([mat, qtd]) => `
              <tr>
                <td style="padding: 0.75rem; border: 1px solid #ddd;">${mat}</td>
                <td style="padding: 0.75rem; text-align: center; border: 1px solid #ddd;"><strong>${qtd}</strong></td>
                <td style="padding: 0.75rem; text-align: center; border: 1px solid #ddd;">${(qtd/total*100).toFixed(1)}%</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>

      <div class="pdf-section">
        <h3>Todos os Registros</h3>
        <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
          <thead>
            <tr style="background: #1F3864; color: #fff;">
              <th style="padding: 0.6rem; text-align: left; border: 1px solid #ddd;">Empresa</th>
              <th style="padding: 0.6rem; text-align: left; border: 1px solid #ddd;">Material</th>
              <th style="padding: 0.6rem; text-align: center; border: 1px solid #ddd;">Data</th>
              <th style="padding: 0.6rem; text-align: center; border: 1px solid #ddd;">Qtd</th>
              <th style="padding: 0.6rem; text-align: center; border: 1px solid #ddd;">Status</th>
            </tr>
          </thead>
          <tbody>
            ${this.dados.map(d => {
              const dataFormatada = new Date(d.data + 'T00:00:00').toLocaleDateString('pt-BR');
              return `
              <tr>
                <td style="padding: 0.6rem; border: 1px solid #ddd;">${d.empresa}</td>
                <td style="padding: 0.6rem; border: 1px solid #ddd;">${d.material}</td>
                <td style="padding: 0.6rem; text-align: center; border: 1px solid #ddd;">${dataFormatada}</td>
                <td style="padding: 0.6rem; text-align: center; border: 1px solid #ddd;"><strong>${d.quantidade}</strong></td>
                <td style="padding: 0.6rem; text-align: center; border: 1px solid #ddd;">${d.status}</td>
              </tr>
            `;
            }).join('')}
          </tbody>
        </table>
      </div>
    `;

    document.getElementById('pdf-container').innerHTML = html;
  },

  // ‚îÄ‚îÄ Exportar PDF ‚îÄ‚îÄ
  exportarPDF() {
    const elemento = document.getElementById('pdf-container');
    const opt = {
      margin: 10,
      filename: `relatorio_materiais_${new Date().toISOString().split('T')[0]}.pdf`,
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2, useCORS: true },
      jsPDF: { orientation: 'portrait', unit: 'mm', format: 'a4' }
    };
    html2pdf().set(opt).from(elemento).save();
    this.mostrarAlerta('PDF gerado com sucesso!', 'success');
  },

  // ‚îÄ‚îÄ Exportar CSV ‚îÄ‚îÄ
  exportarCSV() {
    let csv = 'ID,Empresa,Material,Data do Empr√©stimo,Quantidade,Status\n';
    this.dados.forEach(d => {
      csv += `${d.id},"${d.empresa}","${d.material}","${d.data}",${d.quantidade},"${d.status}"\n`;
    });
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `controle_emprestimos_${new Date().toISOString().split('T')[0]}.csv`;
    link.click();
    this.mostrarAlerta('Arquivo CSV exportado com sucesso!', 'success');
  },

  // ‚îÄ‚îÄ Resetar ‚îÄ‚îÄ
  resetarDados() {
    if (confirm('Tem certeza que deseja resetar TODOS os dados para o padr√£o inicial? Esta a√ß√£o n√£o pode ser desfeita!')) {
      localStorage.removeItem(this.STORAGE_KEY);
      this.carregarDados();
      this.atualizarUI();
      this.mostrarAlerta('Dados resetados para o padr√£o inicial!', 'success');
    }
  }
};

// ‚îÄ‚îÄ Inicializar ao carregar a p√°gina ‚îÄ‚îÄ
document.addEventListener('DOMContentLoaded', () => {
  auth.verificarSessao();
});
</script>
</body>
</html>
