<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Controle de Materiais de EmprÃ©stimo - EditÃ¡vel</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
  <style>
    /* â”€â”€ Reset & Base â”€â”€ */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --blue-dark:  #1F3864;
      --blue-mid:   #2E75B6;
      --blue-light: #DDEEFF;
      --accent:     #E84545;
      --success:    #27AE60;
      --bg:         #F0F4FA;
      --card:       #FFFFFF;
      --text:       #1a2340;
      --muted:      #6b7a99;
      --radius:     14px;
      --shadow:     0 4px 24px rgba(31,56,100,.10);
    }
    html { scroll-behavior: smooth; }
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    /* â”€â”€ Header â”€â”€ */
    header {
      background: linear-gradient(135deg, var(--blue-dark) 0%, var(--blue-mid) 100%);
      color: #fff;
      padding: 2.5rem 2rem 2rem;
      text-align: center;
      position: relative;
      overflow: hidden;
    }
    header::before {
      content: '';
      position: absolute; inset: 0;
      background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.04'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
    }
    header h1 { font-size: 2rem; font-weight: 700; letter-spacing: .5px; position: relative; }
    header p  { margin-top: .5rem; opacity: .85; font-size: 1rem; position: relative; }

    /* â”€â”€ Nav pills â”€â”€ */
    nav {
      display: flex; justify-content: center; gap: .75rem;
      padding: 1.25rem 1rem;
      background: var(--card);
      box-shadow: 0 2px 8px rgba(31,56,100,.08);
      flex-wrap: wrap;
    }
    nav button {
      background: var(--blue-light);
      color: var(--blue-dark);
      border: none; border-radius: 50px;
      padding: .5rem 1.4rem;
      font-size: .92rem; font-weight: 600;
      cursor: pointer; transition: all .2s;
    }
    nav button:hover, nav button.active {
      background: var(--blue-mid);
      color: #fff;
      box-shadow: 0 4px 12px rgba(46,117,182,.35);
    }

    /* â”€â”€ Main layout â”€â”€ */
    main { max-width: 1200px; margin: 0 auto; padding: 2rem 1.5rem 4rem; }

    /* â”€â”€ KPI Cards â”€â”€ */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1.25rem;
      margin-bottom: 2.5rem;
    }
    .kpi {
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 1.5rem 1.25rem;
      display: flex; flex-direction: column; align-items: center;
      border-top: 4px solid var(--blue-mid);
      transition: transform .2s;
    }
    .kpi:hover { transform: translateY(-4px); }
    .kpi .icon { font-size: 2rem; margin-bottom: .5rem; }
    .kpi .value { font-size: 2.2rem; font-weight: 800; color: var(--blue-dark); }
    .kpi .label { font-size: .82rem; color: var(--muted); text-align: center; margin-top: .25rem; text-transform: uppercase; letter-spacing: .5px; }

    /* â”€â”€ Section â”€â”€ */
    section { display: none; }
    section.active { display: block; }

    /* â”€â”€ Cards â”€â”€ */
    .card {
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 1.75rem;
      margin-bottom: 2rem;
    }
    .card h2 {
      font-size: 1.15rem; font-weight: 700;
      color: var(--blue-dark);
      margin-bottom: 1.25rem;
      padding-bottom: .6rem;
      border-bottom: 2px solid var(--blue-light);
      display: flex; align-items: center; gap: .5rem;
    }

    /* â”€â”€ Chart grid â”€â”€ */
    .chart-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }
    .chart-wrap { position: relative; height: 300px; }

    /* â”€â”€ Buttons â”€â”€ */
    .btn-group {
      display: flex; gap: .75rem; flex-wrap: wrap;
      margin-bottom: 1.5rem;
    }
    button.btn {
      padding: .6rem 1.2rem;
      border: none;
      border-radius: 8px;
      font-size: .92rem;
      font-weight: 600;
      cursor: pointer;
      transition: all .2s;
      display: flex; align-items: center; gap: .4rem;
    }
    button.btn-primary {
      background: var(--blue-mid);
      color: #fff;
    }
    button.btn-primary:hover {
      background: var(--blue-dark);
      box-shadow: 0 4px 12px rgba(31,56,100,.3);
    }
    button.btn-success {
      background: var(--success);
      color: #fff;
    }
    button.btn-success:hover {
      background: #1e8449;
    }
    button.btn-danger {
      background: var(--accent);
      color: #fff;
    }
    button.btn-danger:hover {
      background: #c73535;
    }
    button.btn-secondary {
      background: #95a5a6;
      color: #fff;
    }
    button.btn-secondary:hover {
      background: #7f8c8d;
    }

    /* â”€â”€ Modal â”€â”€ */
    .modal {
      display: none;
      position: fixed; inset: 0;
      background: rgba(0,0,0,.5);
      z-index: 1000;
      align-items: center; justify-content: center;
    }
    .modal.active { display: flex; }
    .modal-content {
      background: var(--card);
      border-radius: var(--radius);
      padding: 2rem;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 10px 40px rgba(0,0,0,.3);
    }
    .modal-content h3 {
      font-size: 1.3rem;
      color: var(--blue-dark);
      margin-bottom: 1.5rem;
    }
    .form-group {
      margin-bottom: 1.25rem;
    }
    .form-group label {
      display: block;
      font-weight: 600;
      margin-bottom: .4rem;
      color: var(--blue-dark);
      font-size: .9rem;
    }
    .form-group input, .form-group select {
      width: 100%;
      padding: .6rem .8rem;
      border: 1.5px solid #c8d6ea;
      border-radius: 8px;
      font-size: .92rem;
      outline: none;
      transition: border-color .2s;
    }
    .form-group input:focus, .form-group select:focus {
      border-color: var(--blue-mid);
      box-shadow: 0 0 0 3px rgba(46,117,182,.1);
    }
    .modal-buttons {
      display: flex; gap: .75rem; justify-content: flex-end;
      margin-top: 1.75rem;
    }

    /* â”€â”€ Table â”€â”€ */
    .table-wrap { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; font-size: .93rem; }
    thead tr { background: var(--blue-dark); color: #fff; }
    thead th { padding: .85rem 1rem; text-align: left; font-weight: 600; white-space: nowrap; }
    tbody tr { border-bottom: 1px solid #e8edf5; transition: background .15s; }
    tbody tr:hover { background: var(--blue-light); }
    tbody td { padding: .75rem 1rem; }
    .badge {
      display: inline-block;
      padding: .2rem .75rem;
      border-radius: 50px;
      font-size: .78rem; font-weight: 700;
      background: #ffeaea; color: var(--accent);
    }
    .action-btns {
      display: flex; gap: .5rem;
    }
    .action-btns button {
      padding: .35rem .6rem;
      font-size: .8rem;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: all .2s;
    }
    .action-btns .edit-btn {
      background: #3498db;
      color: #fff;
    }
    .action-btns .edit-btn:hover {
      background: #2980b9;
    }
    .action-btns .delete-btn {
      background: var(--accent);
      color: #fff;
    }
    .action-btns .delete-btn:hover {
      background: #c73535;
    }

    /* â”€â”€ Search / Filter â”€â”€ */
    .filter-bar {
      display: flex; gap: 1rem; flex-wrap: wrap;
      margin-bottom: 1.25rem;
    }
    .filter-bar input, .filter-bar select {
      padding: .55rem 1rem;
      border: 1.5px solid #c8d6ea;
      border-radius: 8px;
      font-size: .92rem;
      outline: none;
      transition: border-color .2s;
      flex: 1; min-width: 160px;
    }
    .filter-bar input:focus, .filter-bar select:focus { border-color: var(--blue-mid); }

    /* â”€â”€ Progress bars â”€â”€ */
    .progress-list { display: flex; flex-direction: column; gap: 1rem; }
    .progress-item label {
      display: flex; justify-content: space-between;
      font-size: .9rem; font-weight: 600; margin-bottom: .3rem;
      color: var(--blue-dark);
    }
    .progress-track {
      background: var(--blue-light);
      border-radius: 50px; height: 14px; overflow: hidden;
    }
    .progress-fill {
      height: 100%; border-radius: 50px;
      background: linear-gradient(90deg, var(--blue-mid), #5ba4e0);
      transition: width 1s ease;
    }

    /* â”€â”€ Alert â”€â”€ */
    .alert {
      padding: 1rem 1.25rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      display: none;
    }
    .alert.show { display: block; }
    .alert-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .alert-error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    /* â”€â”€ Footer â”€â”€ */
    footer {
      text-align: center;
      padding: 1.5rem;
      color: var(--muted);
      font-size: .82rem;
      border-top: 1px solid #dde4f0;
      margin-top: 2rem;
    }

    /* â”€â”€ Responsive â”€â”€ */
    @media (max-width: 600px) {
      header h1 { font-size: 1.4rem; }
      .kpi .value { font-size: 1.7rem; }
      .modal-content { width: 95%; }
    }
  </style>
</head>
<body>

<header>
  <h1>ğŸ“‹ Controle de Materiais de EmprÃ©stimo</h1>
  <p>Painel interativo e editÃ¡vel de dÃ©bitos em aberto</p>
</header>

<nav>
  <button class="active" onclick="app.showSection('visao-geral', this)">VisÃ£o Geral</button>
  <button onclick="app.showSection('por-empresa', this)">Por Empresa</button>
  <button onclick="app.showSection('por-material', this)">Por Material</button>
  <button onclick="app.showSection('registros', this)">Gerenciar Registros</button>
</nav>

<main>

  <!-- Alert â”€â”€ -->
  <div id="alert" class="alert"></div>

  <!-- KPIs sempre visÃ­veis -->
  <div class="kpi-grid">
    <div class="kpi">
      <div class="icon">ğŸ“‹</div>
      <div class="value" id="kpiTotal">660</div>
      <div class="label">Total de Itens em DÃ©bito</div>
    </div>
    <div class="kpi">
      <div class="icon">ğŸ¢</div>
      <div class="value" id="kpiEmpresas">4</div>
      <div class="label">Empresas Credoras</div>
    </div>
    <div class="kpi">
      <div class="icon">ğŸ”¨</div>
      <div class="value" id="kpiMateriais">4</div>
      <div class="label">Tipos de Material</div>
    </div>
    <div class="kpi">
      <div class="icon">ğŸ“…</div>
      <div class="value" id="kpiRegistros">7</div>
      <div class="label">Registros de EmprÃ©stimo</div>
    </div>
    <div class="kpi" style="border-top-color: var(--accent);">
      <div class="icon">âš ï¸</div>
      <div class="value" id="kpiAbertos" style="color:var(--accent);">7</div>
      <div class="label">Itens Em Aberto</div>
    </div>
  </div>

  <!-- â”€â”€ VISÃƒO GERAL â”€â”€ -->
  <section id="visao-geral" class="active">
    <div class="chart-grid">
      <div class="card">
        <h2>ğŸ“Š Quantidade por Empresa</h2>
        <div class="chart-wrap"><canvas id="chartEmpresa"></canvas></div>
      </div>
      <div class="card">
        <h2>ğŸ—ï¸ DistribuiÃ§Ã£o por Material</h2>
        <div class="chart-wrap"><canvas id="chartMaterial"></canvas></div>
      </div>
    </div>
    <div class="card">
      <h2>ğŸ“ˆ EmprÃ©stimos por Data</h2>
      <div class="chart-wrap" style="height:260px"><canvas id="chartData"></canvas></div>
    </div>
  </section>

  <!-- â”€â”€ POR EMPRESA â”€â”€ -->
  <section id="por-empresa">
    <div class="card">
      <h2>ğŸ¢ ParticipaÃ§Ã£o por Empresa</h2>
      <div class="progress-list" id="progressEmpresas"></div>
    </div>
    <div class="card">
      <h2>ğŸ“ˆ Comparativo de Empresas</h2>
      <div class="chart-wrap" style="height:320px"><canvas id="chartEmpresaBar"></canvas></div>
    </div>
  </section>

  <!-- â”€â”€ POR MATERIAL â”€â”€ -->
  <section id="por-material">
    <div class="card">
      <h2>ğŸ”¨ ParticipaÃ§Ã£o por Material</h2>
      <div class="progress-list" id="progressMateriais"></div>
    </div>
    <div class="card">
      <h2>ğŸ“ˆ Comparativo de Materiais</h2>
      <div class="chart-wrap" style="height:300px"><canvas id="chartMaterialBar"></canvas></div>
    </div>
  </section>

  <!-- â”€â”€ REGISTROS â”€â”€ -->
  <section id="registros">
    <div class="card">
      <h2>ğŸ“ Gerenciar Registros</h2>
      <div class="btn-group">
        <button class="btn btn-primary" onclick="app.abrirModalNovo()">
          â• Novo Registro
        </button>
        <button class="btn btn-success" onclick="app.exportarCSV()">
          ğŸ’¾ Exportar CSV
        </button>
        <button class="btn btn-secondary" onclick="app.resetarDados()">
          ğŸ”„ Resetar Dados
        </button>
      </div>
      <div class="filter-bar">
        <input type="text" id="searchInput" placeholder="ğŸ” Buscar por empresa ou material..." oninput="app.filtrarTabela()" />
        <select id="filterEmpresa" onchange="app.filtrarTabela()">
          <option value="">Todas as empresas</option>
        </select>
        <select id="filterMaterial" onchange="app.filtrarTabela()">
          <option value="">Todos os materiais</option>
        </select>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Empresa</th>
              <th>Material</th>
              <th>Data do EmprÃ©stimo</th>
              <th>Quantidade</th>
              <th>Status</th>
              <th>AÃ§Ãµes</th>
            </tr>
          </thead>
          <tbody id="tabelaRegistros"></tbody>
        </table>
      </div>
    </div>
  </section>

</main>

<!-- â”€â”€ MODAL â”€â”€ -->
<div id="modal" class="modal">
  <div class="modal-content">
    <h3 id="modalTitle">Novo Registro</h3>
    <form id="formRegistro" onsubmit="app.salvarRegistro(event)">
      <div class="form-group">
        <label for="empresa">Empresa *</label>
        <input type="text" id="empresa" required placeholder="Ex: Felipe Agosti" />
      </div>
      <div class="form-group">
        <label for="material">Material *</label>
        <input type="text" id="material" required placeholder="Ex: Pontalete" />
      </div>
      <div class="form-group">
        <label for="data">Data do EmprÃ©stimo *</label>
        <input type="date" id="data" required />
      </div>
      <div class="form-group">
        <label for="quantidade">Quantidade *</label>
        <input type="number" id="quantidade" required min="1" placeholder="Ex: 20" />
      </div>
      <div class="modal-buttons">
        <button type="button" class="btn btn-secondary" onclick="app.fecharModal()">Cancelar</button>
        <button type="submit" class="btn btn-success">Salvar</button>
      </div>
    </form>
  </div>
</div>

<footer>
  Controle de Materiais de EmprÃ©stimo â€” EditÃ¡vel &mdash; Dados salvos automaticamente no navegador
</footer>

<script>
// â”€â”€ AplicaÃ§Ã£o Principal â”€â”€
const app = {
  STORAGE_KEY: 'controle_emprestimos_dados_v2',
  CORES: ["#2E75B6","#1F3864","#5BA4E0","#E84545","#F5A623","#27AE60","#8E44AD"],
  dados: [],
  editandoId: null,
  charts: {},

  // â”€â”€ InicializaÃ§Ã£o â”€â”€
  init() {
    console.log('Inicializando aplicaÃ§Ã£o...');
    this.carregarDados();
    this.atualizarUI();
    this.setupEventListeners();
    console.log('AplicaÃ§Ã£o inicializada com sucesso!');
  },

  // â”€â”€ Setup de eventos â”€â”€
  setupEventListeners() {
    const modal = document.getElementById('modal');
    modal.addEventListener('click', (e) => {
      if (e.target.id === 'modal') this.fecharModal();
    });
  },

  // â”€â”€ Carregar dados â”€â”€
  carregarDados() {
    try {
      const salvos = localStorage.getItem(this.STORAGE_KEY);
      if (salvos) {
        this.dados = JSON.parse(salvos);
        console.log('Dados carregados do localStorage:', this.dados.length, 'registros');
      } else {
        this.dados = [
          { id:1, empresa:"Felipe Agosti", material:"Pontalete",              data:"2026-01-28", quantidade:20  },
          { id:2, empresa:"Felipe Agosti", material:"Chapa de Madeirite OSB", data:"2026-01-28", quantidade:20  },
          { id:3, empresa:"Felipe Agosti", material:"Pontalete",              data:"2026-02-12", quantidade:150 },
          { id:4, empresa:"Felipe Agosti", material:"TÃ¡bua 30cm",             data:"2026-02-12", quantidade:50  },
          { id:5, empresa:"Murilo",        material:"Pontalete",              data:"2026-02-04", quantidade:220 },
          { id:6, empresa:"Spera Urban",   material:"Pontalete",              data:"2025-02-03", quantidade:100 },
          { id:7, empresa:"Plano Purus",   material:"TÃ¡bua de 30cm",          data:"2026-02-06", quantidade:100 },
        ];
        this.salvarDados();
      }
    } catch (e) {
      console.error('Erro ao carregar dados:', e);
      this.mostrarAlerta('Erro ao carregar dados. Usando dados padrÃ£o.', 'error');
    }
  },

  // â”€â”€ Salvar dados â”€â”€
  salvarDados() {
    try {
      localStorage.setItem(this.STORAGE_KEY, JSON.stringify(this.dados));
      console.log('Dados salvos com sucesso!');
    } catch (e) {
      console.error('Erro ao salvar dados:', e);
      this.mostrarAlerta('Erro ao salvar dados. Tente novamente.', 'error');
    }
  },

  // â”€â”€ Alert â”€â”€
  mostrarAlerta(msg, tipo) {
    const alert = document.getElementById('alert');
    alert.textContent = msg;
    alert.className = `alert show alert-${tipo}`;
    setTimeout(() => alert.classList.remove('show'), 3000);
  },

  // â”€â”€ NavegaÃ§Ã£o â”€â”€
  showSection(id, btn) {
    document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
    document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    btn.classList.add('active');
  },

  // â”€â”€ Modal â”€â”€
  abrirModalNovo() {
    this.editandoId = null;
    document.getElementById('modalTitle').textContent = 'Novo Registro';
    document.getElementById('formRegistro').reset();
    document.getElementById('modal').classList.add('active');
  },

  abrirModalEditar(id) {
    const reg = this.dados.find(d => d.id === id);
    if (!reg) return;
    this.editandoId = id;
    document.getElementById('modalTitle').textContent = 'Editar Registro';
    document.getElementById('empresa').value = reg.empresa;
    document.getElementById('material').value = reg.material;
    document.getElementById('data').value = reg.data;
    document.getElementById('quantidade').value = reg.quantidade;
    document.getElementById('modal').classList.add('active');
  },

  fecharModal() {
    document.getElementById('modal').classList.remove('active');
    this.editandoId = null;
  },

  salvarRegistro(e) {
    e.preventDefault();
    const empresa = document.getElementById('empresa').value.trim();
    const material = document.getElementById('material').value.trim();
    const data = document.getElementById('data').value;
    const quantidade = parseInt(document.getElementById('quantidade').value);

    if (!empresa || !material || !data || !quantidade) {
      this.mostrarAlerta('Preencha todos os campos!', 'error');
      return;
    }

    if (this.editandoId) {
      const idx = this.dados.findIndex(d => d.id === this.editandoId);
      if (idx !== -1) {
        this.dados[idx] = { id: this.editandoId, empresa, material, data, quantidade };
      }
    } else {
      const novoId = Math.max(...this.dados.map(d => d.id), 0) + 1;
      this.dados.push({ id: novoId, empresa, material, data, quantidade });
    }

    this.fecharModal();
    this.salvarDados();
    this.atualizarUI();
    this.mostrarAlerta('Registro salvo com sucesso!', 'success');
  },

  deletarRegistro(id) {
    if (confirm('Tem certeza que deseja deletar este registro?')) {
      this.dados = this.dados.filter(d => d.id !== id);
      this.salvarDados();
      this.atualizarUI();
      this.mostrarAlerta('Registro deletado com sucesso!', 'success');
    }
  },

  // â”€â”€ Agregar â”€â”€
  agrupar(campo) {
    return this.dados.reduce((acc, d) => {
      acc[d[campo]] = (acc[d[campo]] || 0) + d.quantidade;
      return acc;
    }, {});
  },

  // â”€â”€ Atualizar UI â”€â”€
  atualizarUI() {
    const porEmpresa  = this.agrupar('empresa');
    const porMaterial = this.agrupar('material');
    const total = this.dados.reduce((s, d) => s + d.quantidade, 0);

    // KPIs
    document.getElementById('kpiTotal').textContent = total;
    document.getElementById('kpiEmpresas').textContent = Object.keys(porEmpresa).length;
    document.getElementById('kpiMateriais').textContent = Object.keys(porMaterial).length;
    document.getElementById('kpiRegistros').textContent = this.dados.length;
    document.getElementById('kpiAbertos').textContent = this.dados.length;

    // Filtros
    const filterEmp = document.getElementById('filterEmpresa');
    const filterMat = document.getElementById('filterMaterial');
    const empresasAtuais = new Set(this.dados.map(d => d.empresa));
    const materiaisAtuais = new Set(this.dados.map(d => d.material));

    filterEmp.innerHTML = '<option value="">Todas as empresas</option>';
    [...empresasAtuais].sort().forEach(e => {
      filterEmp.innerHTML += `<option>${e}</option>`;
    });

    filterMat.innerHTML = '<option value="">Todos os materiais</option>';
    [...materiaisAtuais].sort().forEach(m => {
      filterMat.innerHTML += `<option>${m}</option>`;
    });

    // Tabela
    this.renderTabela(this.dados);

    // GrÃ¡ficos
    this.atualizarGraficos(porEmpresa, porMaterial, total);
  },

  // â”€â”€ Tabela â”€â”€
  renderTabela(lista) {
    const tbody = document.getElementById('tabelaRegistros');
    tbody.innerHTML = lista.map(d => {
      const dataFormatada = new Date(d.data + 'T00:00:00').toLocaleDateString('pt-BR');
      return `
        <tr>
          <td>${d.id}</td>
          <td><strong>${d.empresa}</strong></td>
          <td>${d.material}</td>
          <td>${dataFormatada}</td>
          <td><strong>${d.quantidade}</strong></td>
          <td><span class="badge">Em aberto</span></td>
          <td>
            <div class="action-btns">
              <button class="edit-btn" onclick="app.abrirModalEditar(${d.id})">âœï¸ Editar</button>
              <button class="delete-btn" onclick="app.deletarRegistro(${d.id})">ğŸ—‘ï¸ Deletar</button>
            </div>
          </td>
        </tr>`;
    }).join('');
  },

  filtrarTabela() {
    const busca    = document.getElementById('searchInput').value.toLowerCase();
    const empresa  = document.getElementById('filterEmpresa').value;
    const material = document.getElementById('filterMaterial').value;
    const filtrado = this.dados.filter(d => {
      const matchBusca   = !busca   || d.empresa.toLowerCase().includes(busca) || d.material.toLowerCase().includes(busca);
      const matchEmpresa = !empresa || d.empresa === empresa;
      const matchMat     = !material|| d.material.toLowerCase().includes(material.toLowerCase());
      return matchBusca && matchEmpresa && matchMat;
    });
    this.renderTabela(filtrado);
  },

  // â”€â”€ GrÃ¡ficos â”€â”€
  atualizarGraficos(porEmpresa, porMaterial, total) {
    // Destruir grÃ¡ficos antigos
    Object.values(this.charts).forEach(chart => {
      try { chart.destroy(); } catch(e) {}
    });
    this.charts = {};

    // GrÃ¡fico: Empresa (doughnut)
    this.charts.empresa = new Chart(document.getElementById('chartEmpresa'), {
      type: 'doughnut',
      data: {
        labels: Object.keys(porEmpresa),
        datasets: [{ data: Object.values(porEmpresa), backgroundColor: this.CORES, borderWidth: 2, borderColor: '#fff' }]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: {
          legend: { position: 'bottom', labels: { padding: 16, font: { size: 12 } } },
          tooltip: { callbacks: { label: ctx => ` ${ctx.label}: ${ctx.raw} itens (${(ctx.raw/total*100).toFixed(1)}%)` } }
        },
        cutout: '60%'
      }
    });

    // GrÃ¡fico: Material (pie)
    this.charts.material = new Chart(document.getElementById('chartMaterial'), {
      type: 'pie',
      data: {
        labels: Object.keys(porMaterial),
        datasets: [{ data: Object.values(porMaterial), backgroundColor: this.CORES, borderWidth: 2, borderColor: '#fff' }]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: {
          legend: { position: 'bottom', labels: { padding: 14, font: { size: 12 } } },
          tooltip: { callbacks: { label: ctx => ` ${ctx.label}: ${ctx.raw} itens (${(ctx.raw/total*100).toFixed(1)}%)` } }
        }
      }
    });

    // GrÃ¡fico: Por data
    const porData = this.dados.reduce((acc, d) => {
      const key = `${d.data} â€“ ${d.empresa}`;
      acc[key] = (acc[key] || 0) + d.quantidade;
      return acc;
    }, {});
    this.charts.data = new Chart(document.getElementById('chartData'), {
      type: 'bar',
      data: {
        labels: Object.keys(porData),
        datasets: [{
          label: 'Quantidade',
          data: Object.values(porData),
          backgroundColor: this.CORES,
          borderRadius: 8,
          borderSkipped: false
        }]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          x: { ticks: { font: { size: 10 }, maxRotation: 30 }, grid: { display: false } },
          y: { beginAtZero: true, grid: { color: '#e8edf5' } }
        }
      }
    });

    // GrÃ¡fico: Empresa bar
    this.charts.empresaBar = new Chart(document.getElementById('chartEmpresaBar'), {
      type: 'bar',
      data: {
        labels: Object.keys(porEmpresa),
        datasets: [{
          label: 'Total de Itens',
          data: Object.values(porEmpresa),
          backgroundColor: this.CORES,
          borderRadius: 10,
          borderSkipped: false
        }]
      },
      options: {
        indexAxis: 'y',
        responsive: true, maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          x: { beginAtZero: true, grid: { color: '#e8edf5' } },
          y: { grid: { display: false } }
        }
      }
    });

    // GrÃ¡fico: Material bar
    this.charts.materialBar = new Chart(document.getElementById('chartMaterialBar'), {
      type: 'bar',
      data: {
        labels: Object.keys(porMaterial),
        datasets: [{
          label: 'Total de Itens',
          data: Object.values(porMaterial),
          backgroundColor: this.CORES,
          borderRadius: 10,
          borderSkipped: false
        }]
      },
      options: {
        indexAxis: 'y',
        responsive: true, maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          x: { beginAtZero: true, grid: { color: '#e8edf5' } },
          y: { grid: { display: false } }
        }
      }
    });

    // Progress bars: Empresas
    const peDiv = document.getElementById('progressEmpresas');
    peDiv.innerHTML = '';
    Object.entries(porEmpresa).sort((a,b) => b[1]-a[1]).forEach(([emp, qtd], i) => {
      const pct = (qtd/total*100).toFixed(1);
      peDiv.innerHTML += `
        <div class="progress-item">
          <label><span>${emp}</span><span>${qtd} itens (${pct}%)</span></label>
          <div class="progress-track">
            <div class="progress-fill" style="width:${pct}%; background: linear-gradient(90deg, ${this.CORES[i]}, ${this.CORES[(i+1)%this.CORES.length]})"></div>
          </div>
        </div>`;
    });

    // Progress bars: Materiais
    const pmDiv = document.getElementById('progressMateriais');
    pmDiv.innerHTML = '';
    Object.entries(porMaterial).sort((a,b) => b[1]-a[1]).forEach(([mat, qtd], i) => {
      const pct = (qtd/total*100).toFixed(1);
      pmDiv.innerHTML += `
        <div class="progress-item">
          <label><span>${mat}</span><span>${qtd} itens (${pct}%)</span></label>
          <div class="progress-track">
            <div class="progress-fill" style="width:${pct}%; background: linear-gradient(90deg, ${this.CORES[i]}, ${this.CORES[(i+1)%this.CORES.length]})"></div>
          </div>
        </div>`;
    });
  },

  // â”€â”€ Exportar CSV â”€â”€
  exportarCSV() {
    let csv = 'ID,Empresa,Material,Data do EmprÃ©stimo,Quantidade,Status\n';
    this.dados.forEach(d => {
      csv += `${d.id},"${d.empresa}","${d.material}","${d.data}",${d.quantidade},"Em aberto"\n`;
    });
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `controle_emprestimos_${new Date().toISOString().split('T')[0]}.csv`;
    link.click();
    this.mostrarAlerta('Arquivo CSV exportado com sucesso!', 'success');
  },

  // â”€â”€ Resetar â”€â”€
  resetarDados() {
    if (confirm('Tem certeza que deseja resetar TODOS os dados para o padrÃ£o inicial? Esta aÃ§Ã£o nÃ£o pode ser desfeita!')) {
      localStorage.removeItem(this.STORAGE_KEY);
      this.carregarDados();
      this.atualizarUI();
      this.mostrarAlerta('Dados resetados para o padrÃ£o inicial!', 'success');
    }
  }
};

// â”€â”€ Inicializar ao carregar a pÃ¡gina â”€â”€
document.addEventListener('DOMContentLoaded', () => {
  app.init();
});
</script>
</body>
</html>
